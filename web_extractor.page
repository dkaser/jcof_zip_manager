Menu="Utilities"
Type="xmenu"
Title="Web Extractor"
Icon="icon.png"
Tag="icon.png"
Markdown="false"
---

<?php
$root = '/mnt/user/';
$allowedExtensions = [
    '7z', 'zip', 'rar', 'tar', 'gz', 'bz2', 'xz', 'lzma', 'z',
    'cab', 'arj', 'iso', 'udf', 'wim', 'dmg', 'vhd', 'vmdk',
    'msi', 'deb', 'rpm', 'cpio', 'chm', 'nsis', 'exe',
    'tar.gz', 'tar.bz2', 'tar.xz', 'tar.zst',
    'lzh', 'lha', 'ace', 'zst', 'img'
];
$extractionResult = '';
$previewResult = '';

$currentPath = isset($_GET['browse']) ? realpath($root . $_GET['browse']) : $root;
if (!$currentPath || strpos($currentPath, $root) !== 0 || !is_dir($currentPath)) {
    $currentPath = $root;
}
$relativePath = trim(str_replace($root, '', $currentPath), '/');

$selectedFile = $_GET['file'] ?? '';
$selectedDestRel = $_GET['dest'] ?? '';
$selectedDestFull = $selectedDestRel ? $root . ltrim($selectedDestRel, '/') : '';

$isFilePicker = isset($_GET['filepicker']);
$isFolderPicker = isset($_GET['folderpicker']);

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $inputDest = $_POST['destination'] ?? '';
    $inputDest = preg_replace('#/+#','/', $inputDest);
    $destination = str_starts_with($inputDest, $root)
        ? $inputDest
        : $root . ltrim($inputDest, '/');

    $filePath = $_POST['selected_file'] ?? '';
    $confirmed = isset($_POST['proceed']);

    if (!$filePath || !file_exists($filePath)) {
        $extractionResult = "<pre>‚ùå No valid file selected.</pre><hr>";
    } else {
        $filename = basename($filePath);
        $ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
        if (preg_match('/\.tar\.gz$/i', $filename)) $ext = 'tar.gz';

        if (!in_array($ext, $allowedExtensions)) {
            $extractionResult = "<pre>‚ùå Invalid file type: .$ext</pre><hr>";
        } elseif (isset($_POST['preview']) && !isset($_POST['extract'])) {
            exec("/usr/bin/7z l -ba " . escapeshellarg($filePath), $output);
            $filtered = array_filter($output, fn($line) => trim($line) !== '' && !str_starts_with($line, 'Listing archive:'));
            $previewResult = "<div class='preview-box'><strong>üì¶ Archive Contents:</strong><br><pre>" . htmlspecialchars(implode("\n", $filtered)) . "</pre></div>";
        } elseif (isset($_POST['extract'])) {
            // Check for overwrite conflicts using 7z l table parsing
            $conflicts = [];
            $files = [];
            $inListing = false;

            exec("/usr/bin/7z l " . escapeshellarg($filePath), $listing);

            foreach ($listing as $line) {
                if (preg_match('/^-+$/', $line)) {
                    $inListing = !$inListing;
                    continue;
                }

                if ($inListing && preg_match('/^\d{4}-\d{2}-\d{2}/', $line)) {
                    $parts = preg_split('/\s{2,}/', $line);
                    $filename = end($parts);
                    if ($filename && substr($filename, -1) !== '/') {
                        $files[] = $filename;
                    }
                }
            }

            foreach ($files as $relative) {
                $targetPath = rtrim($destination, '/') . '/' . $relative;
                if (file_exists($targetPath)) {
                    $conflicts[] = $relative;
                }
            }

            if (count($conflicts) > 0 && !$confirmed) {
                $extractionResult = "<pre>‚ö†Ô∏è The following files already exist in the destination:\n\n";
                foreach ($conflicts as $conflict) {
                    $extractionResult .= " - $conflict\n";
                }
                $extractionResult .= "\nPlease confirm to proceed with overwriting.</pre>";
                $extractionResult .= '<form method="post">';
                $extractionResult .= '<input type="hidden" name="selected_file" value="' . htmlspecialchars($filePath) . '">';
                $extractionResult .= '<input type="hidden" name="destination" value="' . htmlspecialchars($destination) . '">';
                $extractionResult .= '<input type="hidden" name="extract" value="1">';
                $extractionResult .= '<input type="hidden" name="proceed" value="1">';
                $extractionResult .= '<input type="submit" value="Proceed Anyway">';
                $extractionResult .= '</form><hr>';
            } else {
                $cmd = "/usr/bin/7z x " . escapeshellarg($filePath) . " -o" . escapeshellarg($destination) . " -y";
                exec($cmd, $output, $resultCode);
                $extractionResult = "<pre>";
                $extractionResult .= $resultCode === 0
                    ? "‚úÖ Extraction successful to: " . htmlspecialchars($destination) . "\n"
                    : "‚ùå Extraction failed (code $resultCode)\n";
                $extractionResult .= htmlspecialchars(implode("\n", $output));
                $extractionResult .= "</pre><hr>";
            }
        }
    }
}
?>

<!DOCTYPE html>
<html>
<head>
  <title>7z Extractor</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    label { display: block; margin-top: 1em; }
    .folder-list {
      margin-top: 0.5em;
      padding-left: 1em;
      border-left: 2px solid #ccc;
      max-height: 300px;
      overflow-y: auto;
      background: #fff;
    }
    .folder-list a {
      display: block;
      margin: 0.2em 0;
      text-decoration: none;
      color: orange;
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .folder-list a:hover {
      background: #ffe5cc;
    }
    .preview-box {
      margin-top: 2em;
      padding: 1em;
      background: #fff8f0;
      border: 1px solid orange;
      border-radius: 5px;
      white-space: pre-wrap;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>Extract archive using 7z</h2>
  <form action="" method="post">
    <label>Select archive file:
      <input type="text" name="selected_file" value="<?= htmlspecialchars($selectedFile) ?>" readonly onclick="window.location='?filepicker=1&browse=<?= urlencode($relativePath) ?>&file=<?= urlencode($selectedFile) ?>&dest=<?= urlencode($selectedDestRel) ?>'">
    </label>

    <label>Destination folder:
      <input type="text" name="destination" value="<?= $selectedDestRel ? htmlspecialchars($root . ltrim($selectedDestRel, '/')) : '' ?>" readonly onclick="window.location='?folderpicker=1&browse=<?= urlencode($relativePath) ?>&file=<?= urlencode($selectedFile) ?>&dest=<?= urlencode($selectedDestRel) ?>'">
    </label>

      <input type="submit" name="preview" value="Check Archive">
      <input type="submit" name="extract" value="Extract">

    <?php if ($isFilePicker): ?>
    <div class="folder-list">
      <?php
      foreach (scandir($currentPath) as $entry) {
          $path = $currentPath . '/' . $entry;
          if ($entry === '.' || $entry === '..') continue;

          if (is_dir($path)) {
              $sub = trim(str_replace($root, '', $path), '/');
              echo '<a href="?filepicker=1&browse=' . urlencode($sub) . '&file=' . urlencode($selectedFile) . '&dest=' . urlencode($selectedDestRel) . '">' . htmlspecialchars("üìÇ $entry") . '</a>';
          } elseif (preg_match('/\.(7z|zip|rar|tar\.gz|gz)$/i', $entry)) {
              echo '<a href="?file=' . urlencode($path) . '&dest=' . urlencode($selectedDestRel) . '">' . htmlspecialchars("üìÑ $entry") . '</a>';
          }
      }
      ?>
    </div>
    <?php endif; ?>

    <?php if ($isFolderPicker): ?>
    <div class="folder-list">
      <?php
      if ($currentPath !== $root) {
          $parent = dirname($currentPath);
          echo '<a href="?folderpicker=1&browse=' . urlencode(trim(str_replace($root, '', $parent), '/')) . '&file=' . urlencode($selectedFile) . '&dest=' . urlencode($selectedDestRel) . '">‚¨ÜÔ∏è Up</a>';
      }

      foreach (scandir($currentPath) as $entry) {
          $path = $currentPath . '/' . $entry;
          if ($entry === '.' || $entry === '..') continue;
          if (is_dir($path)) {
              $rel = trim(str_replace($root, '', $path), '/');
              echo '<a href="?dest=' . urlencode($rel) . '&file=' . urlencode($selectedFile) . '">' . htmlspecialchars("üìÇ $entry") . '</a>';
          }
      }
      ?>
    </div>
    <?php endif; ?>
  </form>

  <?= $previewResult ?>
  <?= $extractionResult ?>
</body>
</html>

Menu="Utilities"
Type="xmenu"
Title="Web Extractor"
Icon="icon.png"
Tag="icon.png"
Markdown="false"
---

<?php
$root = '/mnt/user/';
$allowedExtensions = ['7z', 'zip', 'rar', 'tar.gz', 'gz'];
$extractionResult = '';
$previewResult = '';

$currentPath = isset($_GET['browse']) ? realpath($root . $_GET['browse']) : $root;
if (!$currentPath || strpos($currentPath, $root) !== 0 || !is_dir($currentPath)) {
    $currentPath = $root;
}
$relativePath = trim(str_replace($root, '', $currentPath), '/');

$selectedFile = $_GET['file'] ?? '';
$selectedDestRel = $_GET['dest'] ?? '';
$selectedDestFull = $selectedDestRel ? $root . ltrim($selectedDestRel, '/') : '';

$isFilePicker = isset($_GET['filepicker']);
$isFolderPicker = isset($_GET['folderpicker']);

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $inputDest = $_POST['destination'] ?? '';
    $inputDest = preg_replace('#/+#','/', $inputDest);
    $destination = str_starts_with($inputDest, $root)
        ? $inputDest
        : $root . ltrim($inputDest, '/');

    $filePath = $_POST['selected_file'] ?? '';

    if (!$filePath || !file_exists($filePath)) {
        $extractionResult = "<pre>‚ùå No valid file selected.</pre><hr>";
    } else {
        $filename = basename($filePath);
        $ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
        if (preg_match('/\.tar\.gz$/i', $filename)) $ext = 'tar.gz';

        if (!in_array($ext, $allowedExtensions)) {
            $extractionResult = "<pre>‚ùå Invalid file type: .$ext</pre><hr>";
        } elseif (isset($_POST['preview']) && !isset($_POST['extract'])) {
            exec("/usr/bin/7z l -ba " . escapeshellarg($filePath), $output);
            $filtered = array_filter($output, fn($line) => trim($line) !== '' && !str_starts_with($line, 'Listing archive:'));
            $previewResult = "<div class='preview-box'><strong>üì¶ Archive Contents:</strong><br><pre>" . htmlspecialchars(implode("\n", $filtered)) . "</pre></div>";
        } elseif (isset($_POST['extract'])) {
            $cmd = "/usr/bin/7z x " . escapeshellarg($filePath) . " -o" . escapeshellarg($destination) . " -y";
            exec($cmd, $output, $resultCode);
            $extractionResult = "<pre>";
            $extractionResult .= $resultCode === 0
                ? "‚úÖ Extraction successful to: " . htmlspecialchars($destination) . "\n"
                : "‚ùå Extraction failed (code $resultCode)\n";
            $extractionResult .= htmlspecialchars(implode("\n", $output));
            $extractionResult .= "</pre><hr>";
        }
    }
}
?>

<!DOCTYPE html>
<html>
<head>
  <title>7z Extractor</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    label { display: block; margin-top: 1em; }
    input[type="submit"].orange-button {
      margin-top: 1em;
      background-color: #f39c12;
      color: #fff;
      border: 1px solid #e08e0b;
      padding: 0.5em 1.2em;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.15);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    input[type="submit"].orange-button:hover {
      background-color: #e08e0b;
    }
    .folder-list {
      margin-top: 0.5em;
      padding-left: 1em;
      border-left: 2px solid #ccc;
      max-height: 300px;
      overflow-y: auto;
      background: #fff;
    }
    .folder-list a {
      display: block;
      margin: 0.2em 0;
      text-decoration: none;
      color: orange;
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .folder-list a:hover {
      background: #ffe5cc;
    }
    .preview-box {
      margin-top: 2em;
      padding: 1em;
      background: #fff8f0;
      border: 1px solid orange;
      border-radius: 5px;
      white-space: pre-wrap;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>Extract Archive</h2>
  <form action="" method="post">
    <label>Select archive file:
      <input type="text" name="selected_file" value="<?= htmlspecialchars($selectedFile) ?>" readonly onclick="window.location='?filepicker=1&browse=<?= urlencode($relativePath) ?>&file=<?= urlencode($selectedFile) ?>&dest=<?= urlencode($selectedDestRel) ?>'">
    </label>

    <label>Destination folder:
      <input type="text" name="destination" value="<?= $selectedDestRel ? htmlspecialchars($root . ltrim($selectedDestRel, '/')) : '' ?>" readonly onclick="window.location='?folderpicker=1&browse=<?= urlencode($relativePath) ?>&file=<?= urlencode($selectedFile) ?>&dest=<?= urlencode($selectedDestRel) ?>'">
    </label>

    <?php if ($selectedFile): ?>
		<input type="submit" name="preview" value="Check Archive">
		<input type="submit" name="extract" value="Extract">
    <?php endif; ?>

    <?php if ($isFilePicker): ?>
    <div class="folder-list">
      <?php
      foreach (scandir($currentPath) as $entry) {
          $path = $currentPath . '/' . $entry;
          if ($entry === '.' || $entry === '..') continue;

          if (is_dir($path)) {
              $sub = trim(str_replace($root, '', $path), '/');
              echo '<a href="?filepicker=1&browse=' . urlencode($sub) . '&file=' . urlencode($selectedFile) . '&dest=' . urlencode($selectedDestRel) . '">' . htmlspecialchars("üìÇ $entry") . '</a>';
          } elseif (preg_match('/\.(7z|zip|rar|tar\.gz|gz)$/i', $entry)) {
              echo '<a href="?file=' . urlencode($path) . '&dest=' . urlencode($selectedDestRel) . '">' . htmlspecialchars("üìÑ $entry") . '</a>';
          }
      }
      ?>
    </div>
    <?php endif; ?>

    <?php if ($isFolderPicker): ?>
    <div class="folder-list">
      <?php
      if ($currentPath !== $root) {
          $parent = dirname($currentPath);
          echo '<a href="?folderpicker=1&browse=' . urlencode(trim(str_replace($root, '', $parent), '/')) . '&file=' . urlencode($selectedFile) . '&dest=' . urlencode($selectedDestRel) . '">‚¨ÜÔ∏è Up</a>';
      }

      foreach (scandir($currentPath) as $entry) {
          $path = $currentPath . '/' . $entry;
          if ($entry === '.' || $entry === '..') continue;
          if (is_dir($path)) {
              $rel = trim(str_replace($root, '', $path), '/');
              echo '<a href="?dest=' . urlencode($rel) . '&file=' . urlencode($selectedFile) . '">' . htmlspecialchars("üìÇ $entry") . '</a>';
          }
      }
      ?>
    </div>
    <?php endif; ?>
  </form>

  <?= $previewResult ?>
  <?= $extractionResult ?>
</body>
</html>
